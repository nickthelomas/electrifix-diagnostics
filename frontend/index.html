<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectriFix Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
        .signal-indicator { transition: all 0.3s ease; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Component Test Animations */
        @keyframes wheel-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .wheel-spinning {
            animation: wheel-spin var(--spin-duration, 2s) linear infinite;
            transform-origin: center;
        }
        @keyframes brake-pulse {
            0%, 100% { filter: drop-shadow(0 0 3px #ef4444); }
            50% { filter: drop-shadow(0 0 8px #ef4444); }
        }
        .brake-active {
            animation: brake-pulse 0.5s ease-in-out infinite;
        }
        @keyframes headlight-glow {
            0%, 100% { opacity: 0.9; filter: drop-shadow(0 0 5px #fbbf24); }
            50% { opacity: 1; filter: drop-shadow(0 0 10px #fbbf24); }
        }
        .headlight-on {
            animation: headlight-glow 1s ease-in-out infinite;
            fill: #fbbf24 !important;
            opacity: 1 !important;
        }
        @keyframes motor-heat {
            0%, 100% { fill: #4b5563; }
            50% { fill: #f97316; }
        }
        .motor-hot {
            animation: motor-heat 1s ease-in-out infinite;
        }
        @keyframes controller-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .controller-active {
            animation: controller-pulse 0.3s ease-in-out;
        }
        .component-ok { filter: drop-shadow(0 0 4px #22c55e); }
        .component-warning { filter: drop-shadow(0 0 4px #f59e0b); }
        .component-error { filter: drop-shadow(0 0 4px #ef4444); }
        .status-ok { color: #22c55e; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">

    <!-- Header -->
    <header class="bg-blue-800 text-white p-4">
        <h1 class="text-xl font-bold">ElectriFix Diagnostics</h1>
        <p class="text-blue-200 text-sm">UART Diagnostic Tool</p>
    </header>

    <!-- Navigation - Fixed mobile layout -->
    <nav class="bg-white shadow flex overflow-x-auto">
        <button onclick="showView('dashboard')" id="tab-dashboard" class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap">Dashboard</button>
        <button onclick="showView('diagnose')" id="tab-diagnose" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">Diagnose</button>
        <button onclick="showView('component-test')" id="tab-component-test" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">Component Test</button>
        <button onclick="showView('guided')" id="tab-guided" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">Guided Test</button>
        <button onclick="showView('models')" id="tab-models" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">Models</button>
        <button onclick="showView('history')" id="tab-history" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">History</button>
        <button onclick="showView('settings')" id="tab-settings" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">Settings</button>
    </nav>

    <main class="p-4 max-w-4xl mx-auto">

        <!-- Dashboard -->
        <div id="view-dashboard" class="view">
            <!-- Fixed mobile grid: 1 col on mobile, 3 cols on md+ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <p class="text-2xl font-bold" id="stat-total">0</p>
                    <p class="text-xs text-gray-500">Diagnoses</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <p class="text-2xl font-bold" id="stat-accuracy">0%</p>
                    <p class="text-xs text-gray-500">Accuracy</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <p class="text-2xl font-bold" id="stat-completed">0</p>
                    <p class="text-xs text-gray-500">Completed</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <button onclick="showView('diagnose')" class="py-4 bg-blue-600 text-white rounded-lg font-bold text-lg">
                    + New Diagnosis
                </button>
                <button onclick="showView('guided')" class="py-4 bg-purple-600 text-white rounded-lg font-bold text-lg">
                    Guided Test
                </button>
            </div>

            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b font-semibold flex justify-between items-center">
                    <span>Recent Diagnoses</span>
                    <button onclick="exportHistoryCSV()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Export CSV</button>
                </div>
                <div id="recent-list" class="p-4 text-gray-500 text-center">
                    No diagnoses yet
                </div>
            </div>
        </div>

        <!-- Diagnose -->
        <div id="view-diagnose" class="view hidden">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">New Diagnosis</h2>

                <label class="block text-sm font-medium mb-1">Scooter Model</label>
                <select id="model-select" class="w-full p-3 border rounded-lg mb-4" onchange="onModelSelect()">
                    <option value="">Loading models...</option>
                </select>

                <!-- Wiring Diagram Display -->
                <div id="wiring-diagram-section" class="mb-4 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">Tap Point Instructions</h3>
                        <p id="tap-instructions" class="text-sm text-blue-700 mb-3"></p>
                        <div id="wiring-image-container" class="hidden">
                            <img id="wiring-image" class="max-w-full h-auto rounded border" alt="Wiring Diagram">
                        </div>
                        <div id="wiring-pins" class="mt-3 text-sm"></div>
                    </div>
                </div>

                <label class="block text-sm font-medium mb-1">Symptoms</label>
                <textarea id="symptoms" class="w-full p-3 border rounded-lg mb-4 h-24" placeholder="Describe the issue..."></textarea>

                <!-- Simulation Mode Toggle -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="simulation-mode" class="mr-3 h-5 w-5" onchange="toggleSimulationMode()">
                        <span class="font-medium">Use Simulated Data</span>
                    </label>
                    <p class="text-sm text-yellow-700 mt-1">Test the UI without a real scooter connected</p>

                    <div id="simulation-options" class="mt-3 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Protocol</label>
                                <select id="sim-protocol" class="w-full p-2 border rounded">
                                    <option value="jp_qs_s4">JP/QS-S4 (1200 baud)</option>
                                    <option value="ninebot">Ninebot (115200 baud)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Inject Fault</label>
                                <select id="sim-fault" class="w-full p-2 border rounded">
                                    <option value="none">None (Normal)</option>
                                    <option value="stuck_throttle">Stuck Throttle</option>
                                    <option value="checksum_errors">Checksum Errors</option>
                                    <option value="no_response">No Response</option>
                                    <option value="intermittent">Intermittent Connection</option>
                                    <option value="overvoltage">Overvoltage</option>
                                    <option value="undervoltage">Undervoltage</option>
                                    <option value="motor_error">Motor Error</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Serial Port Selection (hidden in simulation mode) -->
                <div id="serial-section">
                    <label class="block text-sm font-medium mb-1">Serial Port</label>
                    <select id="port-select" class="w-full p-3 border rounded-lg mb-4">
                        <option value="">Loading ports...</option>
                    </select>

                    <label class="block text-sm font-medium mb-1">Baud Rate</label>
                    <div class="flex gap-2 mb-4">
                        <select id="baud-select" class="flex-1 p-3 border rounded-lg">
                            <option value="1200">1200 (JP/QS-S4)</option>
                            <option value="9600">9600</option>
                            <option value="115200">115200 (Ninebot)</option>
                        </select>
                        <button onclick="autoDetectBaud()" id="btn-detect" class="px-4 py-3 bg-purple-600 text-white rounded-lg font-medium">Auto-Detect</button>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button onclick="startCapture()" id="btn-start" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium">Start Capture</button>
                    <button onclick="stopCapture()" id="btn-stop" class="flex-1 py-3 bg-red-600 text-white rounded-lg font-medium hidden">Stop Capture</button>
                </div>

                <!-- Signal Quality Indicator -->
                <div id="signal-quality" class="mb-4 hidden">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">Signal Quality</span>
                        <div class="flex items-center gap-2">
                            <div id="signal-bar" class="w-24 h-4 bg-gray-200 rounded-full overflow-hidden">
                                <div id="signal-fill" class="h-full bg-green-500 transition-all" style="width: 0%"></div>
                            </div>
                            <span id="signal-text" class="text-sm font-medium">--</span>
                            <div id="signal-dot" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        </div>
                    </div>
                    <p id="signal-detail" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div id="capture-stats" class="text-center p-4 bg-gray-50 rounded-lg hidden">
                    <p class="text-3xl font-bold" id="bytes-count">0</p>
                    <p class="text-sm text-gray-500">bytes captured</p>
                    <p class="text-xs text-gray-400 mt-1" id="packet-count">0 packets</p>
                </div>

                <button onclick="runAnalysis()" id="btn-analyze" class="w-full py-4 bg-blue-600 text-white rounded-lg font-bold mt-4 hidden">
                    Analyze Capture
                </button>

                <!-- Results Section -->
                <div id="results-section" class="mt-4 hidden">
                    <h3 class="text-lg font-bold mb-2">Diagnosis Results</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Protocol:</span>
                            <span id="result-protocol" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Health Score:</span>
                            <span id="result-score" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Issues Found:</span>
                            <span id="result-issues" class="font-medium">-</span>
                        </div>
                    </div>
                    <div id="anomalies-list" class="mt-3"></div>
                    <div id="ai-diagnosis" class="mt-3 hidden">
                        <h4 class="font-bold mb-2">AI Analysis</h4>
                        <div id="ai-content" class="bg-blue-50 rounded-lg p-4 text-sm whitespace-pre-wrap"></div>
                    </div>

                    <!-- Export Buttons -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="exportDiagnosisPDF()" id="btn-export-pdf" class="px-4 py-2 bg-red-600 text-white rounded font-medium text-sm">
                            Export PDF Report
                        </button>
                        <button onclick="exportCaptureBin()" id="btn-export-bin" class="px-4 py-2 bg-gray-600 text-white rounded font-medium text-sm">
                            Export Raw Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guided Test Sequence -->
        <div id="view-guided" class="view hidden">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">Guided Test Sequence</h2>

                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm text-gray-500 mb-1">
                        <span>Progress</span>
                        <span id="guided-progress-text">Step 0 of 8</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full">
                        <div id="guided-progress-bar" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Current Step -->
                <div id="guided-step-container" class="border rounded-lg p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <div id="step-number-badge" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <div class="flex-1">
                            <h3 id="step-title" class="font-bold text-lg mb-2">Loading...</h3>
                            <p id="step-instruction" class="text-gray-600 mb-3"></p>
                            <div class="bg-green-50 border border-green-200 rounded p-2">
                                <span class="text-sm font-medium text-green-700">Expected: </span>
                                <span id="step-expected" class="text-sm text-green-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step Actions -->
                <div id="step-actions" class="flex flex-wrap gap-2 mb-4"></div>

                <!-- Navigation -->
                <div class="flex justify-between">
                    <button onclick="prevGuidedStep()" id="btn-prev-step" class="px-4 py-2 bg-gray-200 text-gray-700 rounded font-medium" disabled>
                        Previous
                    </button>
                    <button onclick="nextGuidedStep()" id="btn-next-step" class="px-4 py-2 bg-blue-600 text-white rounded font-medium">
                        Next Step
                    </button>
                </div>
            </div>
        </div>

        <!-- Component Test -->
        <div id="view-component-test" class="view hidden">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">Component Test - Live Diagnostics</h2>

                <!-- Mode Selection & Status -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="setComponentTestMode('learn')" id="btn-learn-mode" class="px-4 py-2 bg-purple-600 text-white rounded font-medium">Learn Mode</button>
                    <button onclick="setComponentTestMode('test')" id="btn-test-mode" class="px-4 py-2 bg-blue-600 text-white rounded font-medium">Test Mode</button>
                    <button onclick="connectComponentTest()" id="btn-ct-connect" class="px-4 py-2 bg-green-600 text-white rounded font-medium">Connect</button>
                    <button onclick="disconnectComponentTest()" id="btn-ct-disconnect" class="px-4 py-2 bg-red-600 text-white rounded font-medium hidden">Stop</button>
                </div>

                <!-- Status Bar -->
                <div id="ct-status" class="mb-4 p-3 bg-gray-100 rounded-lg text-sm">
                    <span class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-2" id="ct-status-dot"></span>
                    <span id="ct-status-text">Not connected</span>
                </div>

                <!-- Model Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Scooter Model</label>
                    <select id="ct-model-select" class="w-full p-3 border rounded-lg" onchange="onCTModelSelect()">
                        <option value="">-- Select model --</option>
                    </select>
                </div>

                <!-- Main Layout: Scooter Diagram + Live Data -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Scooter Diagram -->
                    <div class="bg-gray-50 rounded-lg p-4" id="scooter-diagram-container">
                        <h3 class="font-semibold mb-3 text-center">Scooter Diagram</h3>
                        <div class="relative w-full max-w-xs mx-auto">
                            <!-- SVG Scooter Diagram -->
                            <svg viewBox="0 0 200 200" class="w-full h-auto" id="scooter-svg">
                                <!-- Background -->
                                <rect x="0" y="0" width="200" height="200" fill="#f9fafb"/>

                                <!-- Rear Wheel -->
                                <g id="wheel-rear" transform="translate(50, 160)">
                                    <circle cx="0" cy="0" r="25" fill="none" stroke="#374151" stroke-width="4"/>
                                    <circle cx="0" cy="0" r="18" fill="none" stroke="#9ca3af" stroke-width="2"/>
                                    <line x1="-15" y1="0" x2="15" y2="0" stroke="#9ca3af" stroke-width="2"/>
                                    <line x1="0" y1="-15" x2="0" y2="15" stroke="#9ca3af" stroke-width="2"/>
                                </g>

                                <!-- Front Wheel -->
                                <g id="wheel-front" transform="translate(150, 160)">
                                    <circle cx="0" cy="0" r="25" fill="none" stroke="#374151" stroke-width="4"/>
                                    <circle cx="0" cy="0" r="18" fill="none" stroke="#9ca3af" stroke-width="2"/>
                                    <line x1="-15" y1="0" x2="15" y2="0" stroke="#9ca3af" stroke-width="2"/>
                                    <line x1="0" y1="-15" x2="0" y2="15" stroke="#9ca3af" stroke-width="2"/>
                                </g>

                                <!-- Deck -->
                                <rect id="deck" x="40" y="125" width="120" height="20" rx="5" fill="#1e40af"/>

                                <!-- Battery (inside deck) -->
                                <rect id="battery-indicator" x="50" y="130" width="60" height="10" rx="2" fill="#22c55e"/>

                                <!-- Stem -->
                                <line x1="150" y1="125" x2="160" y2="50" stroke="#374151" stroke-width="6" stroke-linecap="round"/>

                                <!-- Handlebar -->
                                <line x1="140" y1="50" x2="180" y2="50" stroke="#374151" stroke-width="4" stroke-linecap="round"/>

                                <!-- Throttle Grip -->
                                <rect id="throttle-grip" x="170" y="43" width="15" height="14" rx="3" fill="#6b7280"/>

                                <!-- Brake Lever -->
                                <g id="brake-lever" transform="translate(135, 45)">
                                    <rect x="0" y="0" width="8" height="3" fill="#6b7280"/>
                                    <rect id="brake-lever-arm" x="-5" y="0" width="10" height="3" rx="1" fill="#9ca3af"/>
                                </g>

                                <!-- Display/Dashboard -->
                                <rect id="dashboard-display" x="150" y="55" width="15" height="12" rx="2" fill="#1f2937"/>
                                <rect x="152" y="57" width="11" height="8" rx="1" fill="#10b981" id="display-screen"/>

                                <!-- Headlight -->
                                <circle id="headlight" cx="165" cy="40" r="5" fill="#fbbf24" opacity="0.3"/>

                                <!-- Motor (rear hub) -->
                                <circle id="motor" cx="50" cy="160" r="12" fill="#4b5563"/>

                                <!-- Controller Box -->
                                <rect id="controller-box" x="70" y="100" width="25" height="15" rx="2" fill="#374151"/>
                            </svg>

                            <!-- Component Labels (overlays) -->
                            <div id="ct-labels" class="absolute inset-0 pointer-events-none">
                                <span class="absolute text-xs bg-white/80 px-1 rounded" style="top: 15%; left: 85%;" id="label-headlight">Light</span>
                                <span class="absolute text-xs bg-white/80 px-1 rounded" style="top: 20%; left: 65%;" id="label-throttle">Throttle</span>
                                <span class="absolute text-xs bg-white/80 px-1 rounded" style="top: 45%; left: 30%;" id="label-controller">Ctrl</span>
                                <span class="absolute text-xs bg-white/80 px-1 rounded" style="top: 75%; left: 5%;" id="label-motor">Motor</span>
                                <span class="absolute text-xs bg-white/80 px-1 rounded" style="top: 60%; left: 20%;" id="label-battery">Battery</span>
                            </div>
                        </div>

                        <!-- Quick Status Icons -->
                        <div class="flex justify-around mt-4 text-center">
                            <div id="qs-throttle" class="p-2">
                                <div class="text-2xl">0%</div>
                                <div class="text-xs text-gray-500">Throttle</div>
                            </div>
                            <div id="qs-brake" class="p-2">
                                <div class="text-2xl text-gray-400">OFF</div>
                                <div class="text-xs text-gray-500">Brake</div>
                            </div>
                            <div id="qs-speed" class="p-2">
                                <div class="text-2xl">0</div>
                                <div class="text-xs text-gray-500">km/h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Data Panel -->
                    <div class="space-y-3" id="live-data-panel">
                        <!-- Throttle -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium">Throttle</span>
                                <span id="ct-throttle-value" class="font-bold">0%</span>
                            </div>
                            <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                                <div id="ct-throttle-bar" class="h-full bg-blue-500 transition-all duration-100" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span id="ct-throttle-status">--</span>
                                <span id="ct-throttle-expected">--</span>
                            </div>
                        </div>

                        <!-- Brake -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">Brake</span>
                                <span id="ct-brake-status" class="font-bold px-2 py-1 rounded bg-gray-200">RELEASED</span>
                            </div>
                            <div class="text-sm text-gray-500 mt-1" id="ct-brake-detail">--</div>
                        </div>

                        <!-- Speed / Wheel -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">Speed / Wheel</span>
                                <span id="ct-speed-value" class="font-bold">0 km/h</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-500 mt-1">
                                <span>RPM: <span id="ct-rpm-value">0</span></span>
                                <span id="ct-wheel-status">Stopped</span>
                            </div>
                        </div>

                        <!-- Battery -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium">Battery</span>
                                <span id="ct-voltage-value" class="font-bold">0V</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Current: <span id="ct-current-value">0A</span></span>
                                <span id="ct-battery-status" class="text-green-600">--</span>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Controls</span>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <span id="ct-mode-eco" class="px-2 py-1 rounded text-xs bg-gray-200">ECO</span>
                                <span id="ct-mode-sport" class="px-2 py-1 rounded text-xs bg-gray-200">SPORT</span>
                                <span id="ct-mode-turbo" class="px-2 py-1 rounded text-xs bg-gray-200">TURBO</span>
                                <span class="text-gray-300">|</span>
                                <span id="ct-headlight-status" class="px-2 py-1 rounded text-xs bg-gray-200">Light OFF</span>
                                <span id="ct-cruise-status" class="px-2 py-1 rounded text-xs bg-gray-200">Cruise OFF</span>
                            </div>
                        </div>

                        <!-- Diagnostics -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium">Diagnostics</span>
                                <span id="ct-error-code" class="font-mono text-sm">0x00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Temp: <span id="ct-temp-value">--C</span></span>
                                <span>Packets/s: <span id="ct-packets-sec">0</span></span>
                            </div>
                            <div id="ct-error-message" class="text-xs text-green-600 mt-1">No errors</div>
                        </div>
                    </div>
                </div>

                <!-- Anomaly Alerts (shown when baseline comparison active) -->
                <div id="ct-anomalies" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Anomalies Detected</h3>
                    <div id="ct-anomaly-list" class="space-y-2"></div>
                </div>

                <!-- Learn Mode Panel (hidden by default) -->
                <div id="learn-mode-panel" class="mt-4 hidden">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-800 mb-3">Learn Mode - Capture Baseline</h3>

                        <!-- Progress -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Progress</span>
                                <span id="learn-progress-text">Step 0 of 8</span>
                            </div>
                            <div class="w-full h-2 bg-purple-200 rounded-full">
                                <div id="learn-progress-bar" class="h-full bg-purple-600 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Current Step -->
                        <div class="bg-white rounded-lg p-3 mb-3">
                            <div class="flex items-start gap-3">
                                <div id="learn-step-badge" class="w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                                <div>
                                    <h4 id="learn-step-title" class="font-bold">Power ON</h4>
                                    <p id="learn-step-instruction" class="text-sm text-gray-600">Power on the scooter and wait...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Live Capture Stats -->
                        <div class="grid grid-cols-3 gap-2 text-center text-sm mb-3">
                            <div class="bg-white rounded p-2">
                                <div class="font-bold" id="learn-throttle-samples">0</div>
                                <div class="text-xs text-gray-500">Throttle</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="font-bold" id="learn-voltage-samples">0</div>
                                <div class="text-xs text-gray-500">Voltage</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="font-bold" id="learn-modes-seen">0</div>
                                <div class="text-xs text-gray-500">Modes</div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button onclick="prevLearnStep()" id="btn-learn-prev" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded font-medium" disabled>Previous</button>
                            <button onclick="nextLearnStep()" id="btn-learn-next" class="flex-1 py-2 bg-purple-600 text-white rounded font-medium">Next Step</button>
                        </div>
                        <button onclick="finishLearnMode()" id="btn-learn-finish" class="w-full mt-2 py-2 bg-green-600 text-white rounded font-medium hidden">Save Baseline</button>
                    </div>
                </div>

                <!-- Baseline Comparison Table (Test Mode) -->
                <div id="baseline-comparison" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Baseline Comparison</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">Component</th>
                                    <th class="p-2 text-left">Current</th>
                                    <th class="p-2 text-left">Baseline</th>
                                    <th class="p-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="baseline-table-body">
                                <tr><td colspan="4" class="p-4 text-center text-gray-500">Load a baseline to compare</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models -->
        <div id="view-models" class="view hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b font-semibold">Scooter Models</div>
                <div id="models-list" class="divide-y"></div>
            </div>
        </div>

        <!-- History -->
        <div id="view-history" class="view hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b font-semibold flex justify-between items-center">
                    <span>Diagnosis History</span>
                    <button onclick="exportHistoryCSV()" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Export CSV</button>
                </div>
                <div id="history-list" class="p-4 text-gray-500 text-center">
                    No history yet
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="view-settings" class="view hidden">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">Settings</h2>

                <label class="block text-sm font-medium mb-1">Claude API Key</label>
                <input type="password" id="api-key" class="w-full p-3 border rounded-lg mb-1" placeholder="sk-or-...">
                <p class="text-xs text-gray-500 mb-2">Must start with sk- or pk- (OpenRouter API key)</p>
                <button onclick="saveApiKey()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium mb-4">Save API Key</button>

                <div id="ai-status" class="text-sm mb-4"></div>

                <label class="block text-sm font-medium mb-1">Serial Ports</label>
                <div id="ports-list" class="bg-gray-50 rounded-lg p-3">
                    <p class="text-gray-500">Loading...</p>
                </div>
                <button onclick="loadPorts()" class="mt-2 text-blue-600 text-sm">Refresh Ports</button>

                <!-- Database Health -->
                <div class="mt-6">
                    <h3 class="font-semibold mb-2">System Health</h3>
                    <div id="db-health" class="bg-gray-50 rounded-lg p-3 text-sm">
                        <button onclick="checkDatabaseHealth()" class="text-blue-600">Check Database Health</button>
                    </div>
                </div>

                <!-- Simulation Mode Config -->
                <div class="mt-6">
                    <h3 class="font-semibold mb-2">Simulation Settings</h3>
                    <div id="sim-status" class="bg-gray-50 rounded-lg p-3 text-sm">
                        Simulation mode: <span id="sim-status-text">Disabled</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-4 right-4 bg-green-600 text-white p-3 rounded-lg text-center hidden"></div>

    </div>

    <script>
        const API = window.location.origin;
        let isCapturing = false;
        let captureBytes = 0;
        let currentDiagnosisId = null;
        let guidedSteps = [];
        let currentGuidedStep = 0;
        let simulationMode = false;
        let signalPollInterval = null;

        // View switching
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById('tab-' + view).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById('tab-' + view).classList.add('border-blue-500', 'text-blue-600');

            if (view === 'guided') loadGuidedSteps();
        }

        // Toast
        function showToast(msg, isError) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'fixed bottom-4 left-4 right-4 p-3 rounded-lg text-center ' + (isError ? 'bg-red-600' : 'bg-green-600') + ' text-white';
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Load data
        async function loadStats() {
            try {
                const res = await fetch(API + '/api/stats');
                const data = await res.json();
                document.getElementById('stat-total').textContent = data.total_diagnoses || 0;
                document.getElementById('stat-accuracy').textContent = (data.accuracy_percentage || 0) + '%';
                document.getElementById('stat-completed').textContent = data.completed_diagnoses || 0;
            } catch(e) { console.error(e); }
        }

        async function loadModels() {
            try {
                const res = await fetch(API + '/api/models');
                const data = await res.json();
                const select = document.getElementById('model-select');
                const list = document.getElementById('models-list');

                select.innerHTML = '<option value="">-- Select model --</option>';
                list.innerHTML = '';

                (data.models || []).forEach(m => {
                    select.innerHTML += `<option value="${m.id}" data-baud="${m.baud_rate}" data-protocol="${m.protocol}">${m.manufacturer} ${m.model_name}</option>`;
                    list.innerHTML += `<div class="p-4">
                        <p class="font-medium">${m.model_name}</p>
                        <p class="text-sm text-gray-500">${m.manufacturer} | ${m.protocol} | ${m.baud_rate} baud</p>
                    </div>`;
                });
            } catch(e) { console.error(e); }
        }

        async function onModelSelect() {
            const select = document.getElementById('model-select');
            const modelId = select.value;

            if (!modelId) {
                document.getElementById('wiring-diagram-section').classList.add('hidden');
                return;
            }

            // Auto-set baud rate
            const option = select.options[select.selectedIndex];
            if (option.dataset.baud) {
                document.getElementById('baud-select').value = option.dataset.baud;
            }
            if (option.dataset.protocol) {
                document.getElementById('sim-protocol').value = option.dataset.protocol;
            }

            // Load wiring diagram
            try {
                const res = await fetch(API + '/api/models/' + modelId + '/wiring-diagram');
                const data = await res.json();

                const section = document.getElementById('wiring-diagram-section');
                section.classList.remove('hidden');

                document.getElementById('tap-instructions').textContent = data.tap_point_instructions || 'No instructions available';

                // Show image if available
                const imgContainer = document.getElementById('wiring-image-container');
                const img = document.getElementById('wiring-image');
                if (data.image_url) {
                    img.src = data.image_url;
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }

                // Show pin definitions
                const pinsDiv = document.getElementById('wiring-pins');
                if (data.wiring_diagram && Object.keys(data.wiring_diagram).length > 0) {
                    let pinsHtml = '<div class="grid grid-cols-2 gap-1 text-xs">';
                    for (const [key, value] of Object.entries(data.wiring_diagram)) {
                        if (key.startsWith('pin_')) {
                            pinsHtml += `<div><span class="font-medium">${key.replace('_', ' ').toUpperCase()}:</span> ${value}</div>`;
                        }
                    }
                    pinsHtml += '</div>';
                    pinsDiv.innerHTML = pinsHtml;
                } else {
                    pinsDiv.innerHTML = '';
                }
            } catch(e) {
                document.getElementById('wiring-diagram-section').classList.add('hidden');
            }
        }

        async function loadPorts() {
            try {
                const res = await fetch(API + '/api/serial/ports');
                const data = await res.json();
                const select = document.getElementById('port-select');
                const list = document.getElementById('ports-list');

                select.innerHTML = '<option value="">-- Select port --</option>';
                list.innerHTML = '';

                const usbPorts = (data.ports || []).filter(p => p.is_usb || p.device.includes('USB'));
                const allPorts = usbPorts.length > 0 ? usbPorts : (data.ports || []).slice(0, 5);

                if (allPorts.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">No ports found</p>';
                } else {
                    allPorts.forEach(p => {
                        select.innerHTML += `<option value="${p.device}">${p.device}</option>`;
                        list.innerHTML += `<p class="py-1">${p.device} <span class="text-gray-400">${p.description}</span></p>`;
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function loadStatus() {
            try {
                const res = await fetch(API + '/api/status');
                const data = await res.json();
                document.getElementById('ai-status').innerHTML = data.ai_configured
                    ? '<span class="text-green-600">✓ AI Connected</span>'
                    : '<span class="text-yellow-600">⚠ AI Not Configured</span>';
            } catch(e) { console.error(e); }
        }

        async function loadHistory() {
            try {
                const res = await fetch(API + '/api/diagnose/history?limit=20');
                const data = await res.json();
                const list = document.getElementById('history-list');
                const recent = document.getElementById('recent-list');

                if ((data.history || []).length === 0) {
                    list.innerHTML = '<p class="p-4 text-gray-500 text-center">No history yet</p>';
                    recent.innerHTML = '<p class="text-gray-500">No diagnoses yet</p>';
                } else {
                    list.innerHTML = '';
                    recent.innerHTML = '';
                    data.history.slice(0, 5).forEach(d => {
                        recent.innerHTML += `<div class="py-2 border-b cursor-pointer hover:bg-gray-50" onclick="viewDiagnosis(${d.id})">
                            <p class="font-medium">${d.model_name}</p>
                            <p class="text-sm text-gray-500">${d.customer_symptoms || 'No symptoms'}</p>
                        </div>`;
                    });
                    data.history.forEach(d => {
                        const statusColor = d.status === 'completed' ? 'bg-green-100 text-green-800' :
                                           d.status === 'diagnosed' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100';
                        list.innerHTML += `<div class="p-4 border-b cursor-pointer hover:bg-gray-50" onclick="viewDiagnosis(${d.id})">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${d.model_name}</p>
                                    <p class="text-sm text-gray-500">${d.customer_symptoms || 'No symptoms'}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded ${statusColor}">${d.status}</span>
                            </div>
                        </div>`;
                    });
                }
            } catch(e) { console.error(e); }
        }

        // Simulation Mode
        function toggleSimulationMode() {
            simulationMode = document.getElementById('simulation-mode').checked;
            document.getElementById('simulation-options').classList.toggle('hidden', !simulationMode);
            document.getElementById('serial-section').classList.toggle('hidden', simulationMode);
            document.getElementById('sim-status-text').textContent = simulationMode ? 'Enabled' : 'Disabled';
        }

        // Auto-detect baud rate
        async function autoDetectBaud() {
            const port = document.getElementById('port-select').value;
            if (!port) { showToast('Select a port first', true); return; }

            const btn = document.getElementById('btn-detect');
            btn.textContent = 'Detecting...';
            btn.disabled = true;

            try {
                const res = await fetch(API + '/api/serial/detect-baud?port=' + encodeURIComponent(port), {method: 'POST'});
                const data = await res.json();
                if (data.success) {
                    document.getElementById('baud-select').value = String(data.baud_rate);
                    showToast('Detected: ' + data.baud_rate + ' baud (' + (data.protocol || 'unknown') + ')');
                } else {
                    showToast(data.message || 'Detection failed - ensure scooter is on', true);
                }
            } catch(e) {
                showToast('Detection failed', true);
            } finally {
                btn.textContent = 'Auto-Detect';
                btn.disabled = false;
            }
        }

        // Capture
        async function startCapture() {
            if (simulationMode) {
                return startSimulationCapture();
            }

            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            if (!port) { showToast('Select a port first', true); return; }

            try {
                const res = await fetch(API + '/api/serial/start?port=' + encodeURIComponent(port) + '&baud_rate=' + baud, {method: 'POST'});
                const data = await res.json();

                if (!res.ok) {
                    showToast(data.detail || 'Failed to start capture', true);
                    return;
                }

                if (data.status === 'capturing') {
                    startCaptureUI();
                } else {
                    showToast('Unexpected response from server', true);
                }
            } catch(e) {
                console.error('Capture start error:', e);
                showToast('Failed to start: ' + (e.message || 'Network error'), true);
            }
        }

        async function startSimulationCapture() {
            const protocol = document.getElementById('sim-protocol').value;
            const fault = document.getElementById('sim-fault').value;

            try {
                const res = await fetch(API + '/api/simulation/start?protocol=' + protocol + '&fault=' + fault, {method: 'POST'});
                const data = await res.json();

                if (!res.ok) {
                    showToast(data.detail || 'Failed to start simulation', true);
                    return;
                }

                if (data.status === 'capturing') {
                    startCaptureUI();
                    showToast('Simulation started (' + protocol + ')');
                } else {
                    showToast('Unexpected response from server', true);
                }
            } catch(e) {
                console.error('Simulation start error:', e);
                showToast('Failed to start simulation: ' + (e.message || 'Network error'), true);
            }
        }

        function startCaptureUI() {
            isCapturing = true;
            captureBytes = 0;
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('capture-stats').classList.remove('hidden');
            document.getElementById('signal-quality').classList.remove('hidden');
            showToast('Capture started');
            pollCapture();
            signalPollInterval = setInterval(pollSignalQuality, 1000);
        }

        async function stopCapture() {
            try {
                const res = await fetch(API + '/api/serial/stop', {method: 'POST'});
                const data = await res.json();
                isCapturing = false;
                if (signalPollInterval) {
                    clearInterval(signalPollInterval);
                    signalPollInterval = null;
                }
                document.getElementById('btn-start').classList.remove('hidden');
                document.getElementById('btn-stop').classList.add('hidden');

                if (!res.ok) {
                    showToast(data.detail || 'Error stopping capture', true);
                    return;
                }

                if (data.total_bytes > 0) {
                    captureBytes = data.total_bytes;
                    document.getElementById('bytes-count').textContent = captureBytes;
                    document.getElementById('btn-analyze').classList.remove('hidden');
                    showToast('Captured ' + captureBytes + ' bytes');
                } else {
                    showToast('No data captured - ensure scooter is powered on', true);
                }
            } catch(e) {
                console.error('Stop capture error:', e);
                showToast('Failed to stop: ' + (e.message || 'Network error'), true);
                // Still reset UI state
                isCapturing = false;
                document.getElementById('btn-start').classList.remove('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
            }
        }

        async function pollCapture() {
            if (!isCapturing) return;
            try {
                const res = await fetch(API + '/api/serial/status');
                const data = await res.json();
                if (data.capturing) {
                    document.getElementById('bytes-count').textContent = data.total_bytes;
                    document.getElementById('packet-count').textContent = data.packet_count + ' packets';
                    setTimeout(pollCapture, 500);
                }
            } catch(e) {}
        }

        async function pollSignalQuality() {
            if (!isCapturing) return;
            try {
                const res = await fetch(API + '/api/serial/signal-quality');
                const data = await res.json();
                updateSignalQuality(data);
            } catch(e) {}
        }

        function updateSignalQuality(data) {
            const fill = document.getElementById('signal-fill');
            const text = document.getElementById('signal-text');
            const dot = document.getElementById('signal-dot');
            const detail = document.getElementById('signal-detail');

            const errorRate = data.checksum_error_rate || 0;
            const quality = 100 - Math.min(100, errorRate * 5);

            fill.style.width = quality + '%';

            if (data.status === 'no_data') {
                fill.className = 'h-full bg-gray-400 transition-all';
                dot.className = 'w-3 h-3 rounded-full bg-gray-400';
                text.textContent = 'No Data';
            } else if (data.color === 'green') {
                fill.className = 'h-full bg-green-500 transition-all';
                dot.className = 'w-3 h-3 rounded-full bg-green-500 pulse';
                text.textContent = 'Good';
            } else if (data.color === 'yellow') {
                fill.className = 'h-full bg-yellow-500 transition-all';
                dot.className = 'w-3 h-3 rounded-full bg-yellow-500 pulse';
                text.textContent = 'Fair';
            } else {
                fill.className = 'h-full bg-red-500 transition-all';
                dot.className = 'w-3 h-3 rounded-full bg-red-500 pulse';
                text.textContent = 'Poor';
            }

            detail.textContent = `${data.total_packets} packets, ${errorRate}% checksum errors`;
        }

        async function runAnalysis() {
            const modelId = document.getElementById('model-select').value;
            const symptoms = document.getElementById('symptoms').value;
            if (!modelId) { showToast('Select a model first', true); return; }

            showToast('Analyzing...');
            try {
                const res = await fetch(API + '/api/diagnose/analyze?model_id=' + modelId + '&customer_symptoms=' + encodeURIComponent(symptoms), {method: 'POST'});
                const data = await res.json();

                if (!res.ok) {
                    showToast(data.detail || 'Analysis failed', true);
                    return;
                }

                if (data.diagnosis_id) {
                    currentDiagnosisId = data.diagnosis_id;
                    showToast('Analysis complete!');
                    loadHistory();
                    displayResults(data);
                } else {
                    showToast('No diagnosis ID returned', true);
                }
            } catch(e) {
                console.error('Analysis error:', e);
                showToast('Analysis failed: ' + (e.message || 'Network error'), true);
            }
        }

        function displayResults(data) {
            const section = document.getElementById('results-section');
            section.classList.remove('hidden');

            document.getElementById('result-protocol').textContent = data.analysis?.protocol || 'Unknown';
            const score = data.analysis?.match_percentage || 0;
            const scoreEl = document.getElementById('result-score');
            scoreEl.textContent = score + '%';
            scoreEl.className = 'font-medium ' + (score >= 70 ? 'text-green-600' : score >= 40 ? 'text-yellow-600' : 'text-red-600');
            document.getElementById('result-issues').textContent = (data.analysis?.anomalies?.length || 0);

            const anomaliesList = document.getElementById('anomalies-list');
            const anomalies = data.analysis?.anomalies || [];
            if (anomalies.length > 0) {
                anomaliesList.innerHTML = '<h4 class="font-bold mb-2">Detected Issues</h4>' +
                    anomalies.map(a => {
                        const color = a.severity === 'critical' ? 'red' : a.severity === 'high' ? 'orange' : a.severity === 'medium' ? 'yellow' : 'gray';
                        return `<div class="p-2 mb-2 rounded bg-${color}-50 border-l-4 border-${color}-500">
                            <span class="text-xs font-bold uppercase text-${color}-700">${a.severity}</span>
                            <span class="text-sm">${a.description}</span></div>`;
                    }).join('');
            } else {
                anomaliesList.innerHTML = '<p class="text-green-600">No issues detected</p>';
            }

            const aiSection = document.getElementById('ai-diagnosis');
            const aiContent = document.getElementById('ai-content');
            if (data.ai_diagnosis?.diagnosis) {
                aiSection.classList.remove('hidden');
                aiContent.textContent = data.ai_diagnosis.diagnosis;
            } else {
                aiSection.classList.add('hidden');
            }
        }

        // Export Functions
        async function exportDiagnosisPDF() {
            if (!currentDiagnosisId) { showToast('No diagnosis to export', true); return; }
            window.open(API + '/api/export/diagnosis/' + currentDiagnosisId + '/pdf', '_blank');
        }

        async function exportCaptureBin() {
            if (!currentDiagnosisId) { showToast('No diagnosis to export', true); return; }
            window.open(API + '/api/export/capture/' + currentDiagnosisId + '/bin', '_blank');
        }

        function exportHistoryCSV() {
            window.open(API + '/api/export/history/csv', '_blank');
        }

        async function viewDiagnosis(id) {
            currentDiagnosisId = id;
            try {
                const res = await fetch(API + '/api/diagnose/' + id);
                const data = await res.json();
                showView('diagnose');
                displayResults({
                    diagnosis_id: id,
                    analysis: {
                        protocol: data.packet_stats ? JSON.parse(data.packet_stats).protocol : 'Unknown',
                        match_percentage: data.comparison_results ? JSON.parse(data.comparison_results).match_percentage : 0,
                        anomalies: (data.raw_anomalies ? JSON.parse(data.raw_anomalies) : []).map(a => ({description: a, severity: 'medium'}))
                    },
                    ai_diagnosis: {
                        diagnosis: data.ai_diagnosis,
                        confidence: data.ai_confidence
                    }
                });
            } catch(e) { showToast('Failed to load diagnosis', true); }
        }

        // Guided Test Sequence
        async function loadGuidedSteps() {
            try {
                const res = await fetch(API + '/api/guided-test/steps');
                const data = await res.json();
                guidedSteps = data.steps || [];
                currentGuidedStep = 0;
                displayGuidedStep();
            } catch(e) { console.error(e); }
        }

        function displayGuidedStep() {
            if (!guidedSteps.length) return;

            const step = guidedSteps[currentGuidedStep];
            document.getElementById('step-number-badge').textContent = step.step_number;
            document.getElementById('step-title').textContent = step.title;
            document.getElementById('step-instruction').textContent = step.instruction;
            document.getElementById('step-expected').textContent = step.expected_result;

            const progress = ((currentGuidedStep + 1) / guidedSteps.length) * 100;
            document.getElementById('guided-progress-bar').style.width = progress + '%';
            document.getElementById('guided-progress-text').textContent = `Step ${currentGuidedStep + 1} of ${guidedSteps.length}`;

            document.getElementById('btn-prev-step').disabled = currentGuidedStep === 0;
            document.getElementById('btn-next-step').textContent = currentGuidedStep === guidedSteps.length - 1 ? 'Finish' : 'Next Step';

            // Show action buttons
            const actionsDiv = document.getElementById('step-actions');
            actionsDiv.innerHTML = '';
            if (step.action === 'capture') {
                actionsDiv.innerHTML = `
                    <button onclick="showView('diagnose'); startCapture();" class="px-4 py-2 bg-green-600 text-white rounded">Start Capture</button>
                    <button onclick="stopCapture();" class="px-4 py-2 bg-red-600 text-white rounded">Stop Capture</button>
                `;
            } else if (step.action === 'analyze') {
                actionsDiv.innerHTML = `<button onclick="showView('diagnose'); runAnalysis();" class="px-4 py-2 bg-blue-600 text-white rounded">Run Analysis</button>`;
            } else if (step.action === 'connect') {
                actionsDiv.innerHTML = `<button onclick="loadPorts();" class="px-4 py-2 bg-purple-600 text-white rounded">Refresh Ports</button>`;
            }
        }

        function nextGuidedStep() {
            if (currentGuidedStep < guidedSteps.length - 1) {
                currentGuidedStep++;
                displayGuidedStep();
            } else {
                showToast('Test sequence complete!');
                showView('diagnose');
            }
        }

        function prevGuidedStep() {
            if (currentGuidedStep > 0) {
                currentGuidedStep--;
                displayGuidedStep();
            }
        }

        async function saveApiKey() {
            const key = document.getElementById('api-key').value;
            if (!key) { showToast('Enter API key', true); return; }

            // Basic validation
            if (!key.startsWith('sk-') && !key.startsWith('pk-')) {
                showToast('API key should start with sk- or pk-', true);
                return;
            }

            try {
                const res = await fetch(API + '/api/settings/api-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({api_key: key})
                });
                const data = await res.json();
                if (data.message && !data.detail) {
                    showToast('API key saved');
                    document.getElementById('api-key').value = '';
                    loadStatus();
                } else {
                    showToast(data.detail || 'Failed to save', true);
                }
            } catch(e) { showToast('Failed to save', true); }
        }

        async function checkDatabaseHealth() {
            try {
                const res = await fetch(API + '/api/health/database');
                const data = await res.json();
                const div = document.getElementById('db-health');
                if (data.healthy) {
                    div.innerHTML = '<span class="text-green-600">✓ Database healthy</span>';
                } else {
                    div.innerHTML = `<span class="text-red-600">✗ Issues found:</span><ul class="list-disc list-inside mt-1">${data.issues.map(i => '<li>' + i + '</li>').join('')}</ul>`;
                }
                if (data.warnings?.length) {
                    div.innerHTML += `<p class="text-yellow-600 mt-2">Warnings: ${data.warnings.length}</p>`;
                }
            } catch(e) { showToast('Health check failed', true); }
        }

        // ========================================
        // COMPONENT TEST FUNCTIONALITY
        // ========================================

        let componentTestWS = null;
        let componentTestMode = 'test'; // 'learn' or 'test'
        let learnSteps = [];
        let currentLearnStep = 0;
        let ctBaseline = null;
        let wheelRotation = 0;

        // Initialize Component Test model dropdown
        async function initComponentTestModels() {
            try {
                const res = await fetch(API + '/api/models');
                const data = await res.json();
                const select = document.getElementById('ct-model-select');
                select.innerHTML = '<option value="">-- Select model --</option>';
                (data.models || []).forEach(m => {
                    select.innerHTML += `<option value="${m.id}" data-protocol="${m.protocol}">${m.manufacturer} ${m.model_name}</option>`;
                });
            } catch(e) { console.error(e); }
        }

        // Set Component Test mode
        function setComponentTestMode(mode) {
            componentTestMode = mode;

            // Update button states
            document.getElementById('btn-learn-mode').classList.toggle('ring-2', mode === 'learn');
            document.getElementById('btn-learn-mode').classList.toggle('ring-purple-300', mode === 'learn');
            document.getElementById('btn-test-mode').classList.toggle('ring-2', mode === 'test');
            document.getElementById('btn-test-mode').classList.toggle('ring-blue-300', mode === 'test');

            // Show/hide panels
            document.getElementById('learn-mode-panel').classList.toggle('hidden', mode !== 'learn');
            document.getElementById('baseline-comparison').classList.toggle('hidden', mode !== 'test');

            if (mode === 'learn') {
                loadLearnSteps();
            }
        }

        // Connect to Component Test WebSocket
        async function connectComponentTest() {
            const modelId = document.getElementById('ct-model-select').value;
            if (!modelId) {
                showToast('Select a scooter model first', true);
                return;
            }

            // First start capture if not already running
            if (!isCapturing) {
                // Use simulation mode for testing
                if (simulationMode) {
                    await startSimulationCapture();
                } else {
                    const port = document.getElementById('port-select').value;
                    const baud = document.getElementById('baud-select').value;
                    if (!port) {
                        showToast('Select a serial port first (or enable simulation mode)', true);
                        return;
                    }
                    try {
                        const res = await fetch(API + '/api/serial/start?port=' + encodeURIComponent(port) + '&baud_rate=' + baud, {method: 'POST'});
                        if (!res.ok) {
                            const data = await res.json();
                            showToast(data.detail || 'Failed to start capture', true);
                            return;
                        }
                        isCapturing = true;
                    } catch(e) {
                        showToast('Failed to start capture', true);
                        return;
                    }
                }
            }

            // Connect WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = wsProtocol + '//' + window.location.host + '/ws/component-test';

            componentTestWS = new WebSocket(wsUrl);

            componentTestWS.onopen = function() {
                updateCTStatus('connected', 'Connected - Receiving data');
                document.getElementById('btn-ct-connect').classList.add('hidden');
                document.getElementById('btn-ct-disconnect').classList.remove('hidden');

                // Load baseline if in test mode
                if (componentTestMode === 'test') {
                    componentTestWS.send(JSON.stringify({action: 'load_baseline', model_id: parseInt(modelId)}));
                } else if (componentTestMode === 'learn') {
                    componentTestWS.send(JSON.stringify({action: 'start_learn', model_id: parseInt(modelId)}));
                }
            };

            componentTestWS.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                handleComponentTestMessage(msg);
            };

            componentTestWS.onclose = function() {
                updateCTStatus('disconnected', 'Disconnected');
                document.getElementById('btn-ct-connect').classList.remove('hidden');
                document.getElementById('btn-ct-disconnect').classList.add('hidden');
            };

            componentTestWS.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateCTStatus('error', 'Connection error');
            };
        }

        // Disconnect Component Test
        async function disconnectComponentTest() {
            if (componentTestWS) {
                if (componentTestMode === 'learn') {
                    componentTestWS.send(JSON.stringify({action: 'stop_learn'}));
                }
                componentTestWS.close();
                componentTestWS = null;
            }

            // Stop capture
            if (isCapturing) {
                await stopCapture();
            }

            updateCTStatus('disconnected', 'Disconnected');
            document.getElementById('btn-ct-connect').classList.remove('hidden');
            document.getElementById('btn-ct-disconnect').classList.add('hidden');
        }

        // Update Component Test status
        function updateCTStatus(status, text) {
            const dot = document.getElementById('ct-status-dot');
            const textEl = document.getElementById('ct-status-text');

            textEl.textContent = text;
            dot.className = 'inline-block w-3 h-3 rounded-full mr-2 ';

            if (status === 'connected') {
                dot.classList.add('bg-green-500', 'pulse');
            } else if (status === 'error') {
                dot.classList.add('bg-red-500');
            } else {
                dot.classList.add('bg-gray-400');
            }
        }

        // Handle Component Test WebSocket messages
        function handleComponentTestMessage(msg) {
            if (msg.type === 'component_data') {
                if (msg.data) {
                    updateComponentDisplay(msg.data);
                    updateScooterDiagram(msg.data);

                    if (msg.data.baseline_comparison) {
                        updateBaselineComparison(msg.data, msg.data.baseline_comparison);
                    }

                    // Update learn mode stats
                    if (msg.data.learn_mode) {
                        updateLearnModeStats(msg.data);
                    }
                }
            } else if (msg.type === 'baseline_loaded') {
                if (msg.has_baseline) {
                    showToast('Baseline loaded for comparison');
                    document.getElementById('baseline-comparison').classList.remove('hidden');
                    loadBaselineData(msg.model_id);
                } else {
                    showToast('No baseline found for this model', true);
                }
            } else if (msg.type === 'learn_started') {
                showToast('Learn mode started');
            } else if (msg.type === 'learn_stopped') {
                showToast('Learn mode stopped');
            }
        }

        // Update component data display
        function updateComponentDisplay(data) {
            // Throttle
            const throttle = data.throttle_percent || 0;
            document.getElementById('ct-throttle-value').textContent = throttle.toFixed(0) + '%';
            document.getElementById('ct-throttle-bar').style.width = throttle + '%';
            document.getElementById('qs-throttle').querySelector('.text-2xl').textContent = throttle.toFixed(0) + '%';

            // Brake
            const brakeEngaged = data.brake_engaged;
            const brakeStatus = document.getElementById('ct-brake-status');
            brakeStatus.textContent = brakeEngaged ? 'ENGAGED' : 'RELEASED';
            brakeStatus.className = 'font-bold px-2 py-1 rounded ' + (brakeEngaged ? 'bg-red-500 text-white' : 'bg-gray-200');
            document.getElementById('ct-brake-detail').textContent = `Brake: ${(data.brake_percent || 0).toFixed(0)}%`;
            document.getElementById('qs-brake').querySelector('.text-2xl').textContent = brakeEngaged ? 'ON' : 'OFF';
            document.getElementById('qs-brake').querySelector('.text-2xl').className = 'text-2xl ' + (brakeEngaged ? 'text-red-500' : 'text-gray-400');

            // Speed
            const speed = data.speed_kmh || 0;
            document.getElementById('ct-speed-value').textContent = speed.toFixed(1) + ' km/h';
            document.getElementById('ct-rpm-value').textContent = data.rpm || 0;
            document.getElementById('ct-wheel-status').textContent = speed > 0 ? 'Spinning' : 'Stopped';
            document.getElementById('qs-speed').querySelector('.text-2xl').textContent = speed.toFixed(0);

            // Battery
            const voltage = data.voltage || 0;
            const current = data.current || 0;
            document.getElementById('ct-voltage-value').textContent = voltage.toFixed(1) + 'V';
            document.getElementById('ct-current-value').textContent = current.toFixed(1) + 'A';

            // Estimate battery percentage (simplified: 48V system, 42V empty, 54V full)
            const batteryPercent = Math.max(0, Math.min(100, ((voltage - 42) / (54 - 42)) * 100));
            let batteryStatus = '';
            if (batteryPercent > 80) batteryStatus = 'Good';
            else if (batteryPercent > 40) batteryStatus = 'OK';
            else if (batteryPercent > 20) batteryStatus = 'Low';
            else batteryStatus = 'Critical';
            document.getElementById('ct-battery-status').textContent = batteryStatus;
            document.getElementById('ct-battery-status').className = batteryPercent > 40 ? 'text-green-600' : batteryPercent > 20 ? 'text-yellow-600' : 'text-red-600';

            // Mode
            const mode = data.mode || 0;
            document.getElementById('ct-mode-eco').className = 'px-2 py-1 rounded text-xs ' + (mode === 0 ? 'bg-green-500 text-white' : 'bg-gray-200');
            document.getElementById('ct-mode-sport').className = 'px-2 py-1 rounded text-xs ' + (mode === 1 ? 'bg-yellow-500 text-white' : 'bg-gray-200');
            document.getElementById('ct-mode-turbo').className = 'px-2 py-1 rounded text-xs ' + (mode === 2 ? 'bg-red-500 text-white' : 'bg-gray-200');

            // Headlight & Cruise
            document.getElementById('ct-headlight-status').textContent = data.headlight ? 'Light ON' : 'Light OFF';
            document.getElementById('ct-headlight-status').className = 'px-2 py-1 rounded text-xs ' + (data.headlight ? 'bg-yellow-400' : 'bg-gray-200');
            document.getElementById('ct-cruise-status').textContent = data.cruise ? 'Cruise ON' : 'Cruise OFF';
            document.getElementById('ct-cruise-status').className = 'px-2 py-1 rounded text-xs ' + (data.cruise ? 'bg-blue-400 text-white' : 'bg-gray-200');

            // Diagnostics
            document.getElementById('ct-temp-value').textContent = (data.temperature || 0) + 'C';
            document.getElementById('ct-error-code').textContent = '0x' + (data.error_code || 0).toString(16).padStart(2, '0').toUpperCase();
            document.getElementById('ct-packets-sec').textContent = (data.packets_per_sec || 0).toFixed(0);

            const errorMsg = document.getElementById('ct-error-message');
            if (data.error_code && data.error_code !== 0) {
                errorMsg.textContent = data.error_message || 'Error detected';
                errorMsg.className = 'text-xs text-red-600 font-bold';
            } else {
                errorMsg.textContent = 'No errors';
                errorMsg.className = 'text-xs text-green-600';
            }
        }

        // Update scooter diagram animations
        function updateScooterDiagram(data) {
            // Wheels rotation
            const rpm = data.rpm || 0;
            const wheelRear = document.getElementById('wheel-rear');
            const wheelFront = document.getElementById('wheel-front');

            if (rpm > 0) {
                const spinDuration = Math.max(0.1, 60 / rpm);
                wheelRear.style.setProperty('--spin-duration', spinDuration + 's');
                wheelFront.style.setProperty('--spin-duration', spinDuration + 's');
                wheelRear.classList.add('wheel-spinning');
                wheelFront.classList.add('wheel-spinning');
            } else {
                wheelRear.classList.remove('wheel-spinning');
                wheelFront.classList.remove('wheel-spinning');
            }

            // Brake lever
            const brakeLever = document.getElementById('brake-lever');
            if (data.brake_engaged) {
                brakeLever.classList.add('brake-active');
            } else {
                brakeLever.classList.remove('brake-active');
            }

            // Headlight
            const headlight = document.getElementById('headlight');
            if (data.headlight) {
                headlight.classList.add('headlight-on');
            } else {
                headlight.classList.remove('headlight-on');
            }

            // Motor temperature
            const motor = document.getElementById('motor');
            if (data.temperature && data.temperature > 50) {
                motor.classList.add('motor-hot');
            } else {
                motor.classList.remove('motor-hot');
            }

            // Controller pulse (when receiving data)
            const controller = document.getElementById('controller-box');
            controller.classList.add('controller-active');
            setTimeout(() => controller.classList.remove('controller-active'), 300);

            // Throttle grip highlight
            const throttleGrip = document.getElementById('throttle-grip');
            const throttle = data.throttle_percent || 0;
            if (throttle > 50) {
                throttleGrip.setAttribute('fill', '#3b82f6');
            } else if (throttle > 10) {
                throttleGrip.setAttribute('fill', '#60a5fa');
            } else {
                throttleGrip.setAttribute('fill', '#6b7280');
            }

            // Battery indicator
            const batteryIndicator = document.getElementById('battery-indicator');
            const voltage = data.voltage || 0;
            const batteryPercent = Math.max(0, Math.min(100, ((voltage - 42) / (54 - 42)) * 100));
            batteryIndicator.setAttribute('width', Math.max(5, batteryPercent * 0.6));
            if (batteryPercent > 50) {
                batteryIndicator.setAttribute('fill', '#22c55e');
            } else if (batteryPercent > 20) {
                batteryIndicator.setAttribute('fill', '#f59e0b');
            } else {
                batteryIndicator.setAttribute('fill', '#ef4444');
            }
        }

        // Update baseline comparison display
        function updateBaselineComparison(data, comparison) {
            const tableBody = document.getElementById('baseline-table-body');
            const anomalyList = document.getElementById('ct-anomaly-list');

            // Build comparison table
            let rows = '';
            const statusIcons = {
                'ok': '<span class="text-green-600">&#10004;</span>',
                'warning': '<span class="text-yellow-600">&#9888;</span>',
                'error': '<span class="text-red-600">&#10008;</span>'
            };

            // Voltage
            if (ctBaseline && ctBaseline.idle_voltage) {
                rows += `<tr>
                    <td class="p-2">Voltage</td>
                    <td class="p-2">${(data.voltage || 0).toFixed(1)}V</td>
                    <td class="p-2">${ctBaseline.idle_voltage.min || '-'}-${ctBaseline.idle_voltage.max || '-'}V</td>
                    <td class="p-2 text-center">${statusIcons[comparison.status?.voltage] || '-'}</td>
                </tr>`;
            }

            // Temperature
            if (ctBaseline && ctBaseline.temperature_normal) {
                rows += `<tr>
                    <td class="p-2">Temperature</td>
                    <td class="p-2">${data.temperature || 0}C</td>
                    <td class="p-2">${ctBaseline.temperature_normal.min || '-'}-${ctBaseline.temperature_normal.max || '-'}C</td>
                    <td class="p-2 text-center">${statusIcons[comparison.status?.temperature] || '-'}</td>
                </tr>`;
            }

            // Current
            if (ctBaseline && ctBaseline.operating_current) {
                rows += `<tr>
                    <td class="p-2">Current</td>
                    <td class="p-2">${(data.current || 0).toFixed(1)}A</td>
                    <td class="p-2">0-${ctBaseline.operating_current.max || '-'}A</td>
                    <td class="p-2 text-center">${statusIcons[comparison.status?.current] || '-'}</td>
                </tr>`;
            }

            // Error code
            rows += `<tr>
                <td class="p-2">Error Code</td>
                <td class="p-2">0x${(data.error_code || 0).toString(16).toUpperCase()}</td>
                <td class="p-2">0x00</td>
                <td class="p-2 text-center">${statusIcons[comparison.status?.error_code] || '-'}</td>
            </tr>`;

            tableBody.innerHTML = rows || '<tr><td colspan="4" class="p-4 text-center text-gray-500">No data</td></tr>';

            // Show anomalies
            if (comparison.anomalies && comparison.anomalies.length > 0) {
                document.getElementById('ct-anomalies').classList.remove('hidden');
                anomalyList.innerHTML = comparison.anomalies.map(a => {
                    const color = a.severity === 'critical' ? 'red' : a.severity === 'high' ? 'orange' : 'yellow';
                    return `<div class="p-2 rounded bg-${color}-50 border-l-4 border-${color}-500">
                        <span class="text-xs font-bold uppercase text-${color}-700">${a.severity}</span>
                        <span class="text-sm ml-2">${a.message}</span>
                    </div>`;
                }).join('');
            } else {
                document.getElementById('ct-anomalies').classList.add('hidden');
            }
        }

        // Load baseline data for display
        async function loadBaselineData(modelId) {
            try {
                const res = await fetch(API + '/api/component-test/baseline/' + modelId);
                if (res.ok) {
                    ctBaseline = await res.json();
                }
            } catch(e) {
                console.error('Failed to load baseline:', e);
            }
        }

        // Model selection handler
        function onCTModelSelect() {
            const modelId = document.getElementById('ct-model-select').value;
            if (modelId && componentTestMode === 'test') {
                loadBaselineData(modelId);
            }
        }

        // ========================================
        // LEARN MODE FUNCTIONALITY
        // ========================================

        async function loadLearnSteps() {
            try {
                const res = await fetch(API + '/api/component-test/learn-steps');
                const data = await res.json();
                learnSteps = data.steps || [];
                currentLearnStep = 0;
                displayLearnStep();
            } catch(e) { console.error(e); }
        }

        function displayLearnStep() {
            if (!learnSteps.length) return;

            const step = learnSteps[currentLearnStep];
            document.getElementById('learn-step-badge').textContent = step.step_number;
            document.getElementById('learn-step-title').textContent = step.title;
            document.getElementById('learn-step-instruction').textContent = step.instruction;

            const progress = ((currentLearnStep + 1) / learnSteps.length) * 100;
            document.getElementById('learn-progress-bar').style.width = progress + '%';
            document.getElementById('learn-progress-text').textContent = `Step ${currentLearnStep + 1} of ${learnSteps.length}`;

            document.getElementById('btn-learn-prev').disabled = currentLearnStep === 0;

            // Show finish button on last step
            const isLastStep = currentLearnStep === learnSteps.length - 1;
            document.getElementById('btn-learn-next').classList.toggle('hidden', isLastStep);
            document.getElementById('btn-learn-finish').classList.toggle('hidden', !isLastStep);
        }

        function nextLearnStep() {
            if (currentLearnStep < learnSteps.length - 1) {
                currentLearnStep++;
                displayLearnStep();

                // Notify WebSocket
                if (componentTestWS && componentTestWS.readyState === WebSocket.OPEN) {
                    componentTestWS.send(JSON.stringify({action: 'next_learn_step'}));
                }
            }
        }

        function prevLearnStep() {
            if (currentLearnStep > 0) {
                currentLearnStep--;
                displayLearnStep();
            }
        }

        function updateLearnModeStats(data) {
            // Update live stats during learn mode
            // These would be updated based on accumulated data from WebSocket
            document.getElementById('learn-throttle-samples').textContent = data.throttle_percent > 0 ? '+' : '0';
            document.getElementById('learn-voltage-samples').textContent = data.voltage > 0 ? '+' : '0';
        }

        async function finishLearnMode() {
            const modelId = document.getElementById('ct-model-select').value;
            if (!modelId) return;

            // Stop learn mode and get baseline data
            try {
                const res = await fetch(API + '/api/component-test/stop-learn', {method: 'POST'});
                const data = await res.json();

                if (data.baseline_data) {
                    // Ask user to confirm saving
                    const notes = prompt('Add notes for this baseline (optional):');

                    const saveRes = await fetch(API + '/api/component-test/save-baseline?model_id=' + modelId, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            ...data.baseline_data,
                            notes: notes || 'Baseline captured via Learn Mode'
                        })
                    });

                    if (saveRes.ok) {
                        showToast('Baseline saved successfully!');
                        setComponentTestMode('test');
                    } else {
                        showToast('Failed to save baseline', true);
                    }
                }
            } catch(e) {
                showToast('Error finishing learn mode', true);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadModels();
            loadPorts();
            loadStatus();
            loadHistory();
            initComponentTestModels();
        });
    </script>
</body>
</html>
